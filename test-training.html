<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>训练系统测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-left: 4px solid #28a745;
      border-radius: 4px;
    }
    .error {
      border-left-color: #dc3545;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    .task-card {
      display: inline-block;
      margin: 10px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      min-width: 200px;
    }
    .task-name {
      font-weight: bold;
      color: #2c3e50;
    }
    .task-difficulty {
      color: #e74c3c;
      font-weight: 600;
    }
    .task-boosts {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #2980b9;
    }
    .chart {
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>OI训练器 - 新训练系统测试</h1>
  
  <div class="section">
    <h2>1. 题目库测试</h2>
    <button onclick="testTaskPool()">测试题目池</button>
    <button onclick="testRandomSelection()">测试随机抽题</button>
    <div id="task-pool-result"></div>
  </div>

  <div class="section">
    <h2>2. 增幅计算测试</h2>
    <button onclick="testBoostCalculation()">测试增幅公式</button>
    <div id="boost-calc-result"></div>
  </div>

  <div class="section">
    <h2>3. 知识点提升测试</h2>
    <button onclick="testKnowledgeBoost()">测试知识提升</button>
    <div id="knowledge-result"></div>
  </div>

  <div class="section">
    <h2>4. 随机抽取的5道题目预览</h2>
    <button onclick="showRandomTasks()">抽取5道题</button>
    <button onclick="simulateAndShowRandomTasks()">模拟学生并抽题（验证匹配数）</button>
    <div id="random-tasks"></div>
  </div>

  <!-- 引入必要的JS文件 -->
  <script src="lib/utils.js"></script>
  <script src="lib/task.js"></script>
  
  <script>
    // 测试题目池
    function testTaskPool() {
      const result = document.getElementById('task-pool-result');
      try {
        const poolSize = TASK_POOL.length;
        const minDiff = Math.min(...TASK_POOL.map(t => t.difficulty));
        const maxDiff = Math.max(...TASK_POOL.map(t => t.difficulty));
        
        result.innerHTML = `
          <div class="test-result">
            ✓ 题目池加载成功<br>
            题目总数: ${poolSize}<br>
            难度范围: ${minDiff} - ${maxDiff}
          </div>
        `;
      } catch(e) {
        result.innerHTML = `<div class="test-result error">✗ 错误: ${e.message}</div>`;
      }
    }

    // 测试随机抽题
    function testRandomSelection() {
      const result = document.getElementById('task-pool-result');
      try {
        const selected = selectRandomTasks(5);
        let html = '<div class="test-result">✓ 随机抽取5道题成功:</div>';
        selected.forEach(task => {
          const boosts = task.boosts.map(b => `${b.type}+${b.amount}`).join(', ');
          html += `<div style="margin:5px 0">- ${task.name} (难度${task.difficulty}) [${boosts}]</div>`;
        });
        result.innerHTML += html;
      } catch(e) {
        result.innerHTML += `<div class="test-result error">✗ 错误: ${e.message}</div>`;
      }
    }

    // 测试增幅计算
    function testBoostCalculation() {
      const result = document.getElementById('boost-calc-result');
      try {
        let html = '<div class="test-result">✓ 增幅计算测试:</div>';
        html += '<table><tr><th>学生能力</th><th>题目难度</th><th>能力差</th><th>增幅倍数</th></tr>';
        
        const testCases = [
          [50, 50],  // 完美匹配
          [60, 50],  // 能力高
          [40, 50],  // 能力低
          [70, 50],  // 能力过高
          [30, 50],  // 能力过低
          [80, 80],  // 高水平匹配
          [20, 20],  // 低水平匹配
        ];
        
        testCases.forEach(([ability, difficulty]) => {
          const multiplier = calculateBoostMultiplier(ability, difficulty);
          const diff = ability - difficulty;
          const percent = (multiplier * 100).toFixed(1);
          html += `<tr><td>${ability}</td><td>${difficulty}</td><td>${diff}</td><td>${percent}%</td></tr>`;
        });
        
        html += '</table>';
        result.innerHTML = html;
      } catch(e) {
        result.innerHTML = `<div class="test-result error">✗ 错误: ${e.message}</div>`;
      }
    }

    // 测试知识点提升
    function testKnowledgeBoost() {
      const result = document.getElementById('knowledge-result');
      try {
        // 创建一个模拟学生
        const mockStudent = {
          thinking: 60,
          coding: 50,
          knowledge_ds: 20,
          knowledge_graph: 15,
          knowledge_string: 10,
          knowledge_math: 25,
          knowledge_dp: 18,
          addKnowledge: function(type, amount) {
            if(type === '数据结构') this.knowledge_ds += amount;
            else if(type === '图论') this.knowledge_graph += amount;
            else if(type === '字符串') this.knowledge_string += amount;
            else if(type === '数学') this.knowledge_math += amount;
            else if(type === 'DP' || type === '动态规划') this.knowledge_dp += amount;
          }
        };
        
        // 选一道题目测试
        const task = TASK_POOL.find(t => t.name.includes('NOIP2022建造军营')) || TASK_POOL[0];
        
        const studentAbility = (mockStudent.thinking + mockStudent.coding) / 2;
        const multiplier = calculateBoostMultiplier(studentAbility, task.difficulty);
        
        let html = `<div class="test-result">✓ 知识提升测试:</div>`;
        html += `<div>题目: ${task.name} (难度${task.difficulty})</div>`;
        html += `<div>学生能力: 思维${mockStudent.thinking} 编码${mockStudent.coding} 平均${studentAbility}</div>`;
        html += `<div>增幅倍数: ${(multiplier * 100).toFixed(1)}%</div>`;
        html += `<table><tr><th>知识点</th><th>基础提升</th><th>实际提升</th></tr>`;
        
        const boostsBefore = {...mockStudent};
        const results = applyTaskBoosts(mockStudent, task);
        
        results.boosts.forEach(b => {
          html += `<tr><td>${b.type}</td><td>+${b.baseAmount}</td><td>+${b.actualAmount}</td></tr>`;
        });
        
        html += '</table>';
        result.innerHTML = html;
      } catch(e) {
        result.innerHTML = `<div class="test-result error">✗ 错误: ${e.message}</div>`;
      }
    }

    // 展示随机抽取的题目
    function showRandomTasks() {
      const container = document.getElementById('random-tasks');
      try {
        const tasks = selectRandomTasks(5);
        let html = '';
        
        tasks.forEach((task, idx) => {
          const boostStr = task.boosts.map(b => `${b.type}+${b.amount}`).join(' ');
          html += `
            <div class="task-card">
              <div class="task-name">${idx + 1}. ${task.name}</div>
              <div class="task-difficulty">难度: ${task.difficulty}</div>
              <div class="task-boosts">[${boostStr}]</div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      } catch(e) {
        container.innerHTML = `<div class="test-result error">✗ 错误: ${e.message}</div>`;
      }
    }

    // 模拟一个全局 game.students，并展示选题同时标注哪些题目与学生平均能力匹配
    function simulateAndShowRandomTasks(){
      const container = document.getElementById('random-tasks');
      try{
        // 创建一个模拟 window.game，包含若干活跃学生
        window.game = window.game || {};
        window.game.students = [
          {thinking: 62, coding: 58, active: true},
          {thinking: 60, coding: 60, active: true},
          {thinking: 61, coding: 59, active: true}
        ];

        // 计算平均能力以便在页面显示
        const actives = window.game.students.filter(s=>s && s.active!==false);
        const avg = actives.reduce((a,s)=>a + ((Number(s.thinking||0) + Number(s.coding||0))/2), 0) / actives.length;

        const tasks = selectRandomTasks(5);

        // 标记哪些题目在针对 avg 能力时属于 topCandidates（与 selectRandomTasks 中逻辑一致）
        const scored = TASK_POOL.map(t=>({task:t, score: calculateBoostMultiplier(avg, t.difficulty)}));
        scored.sort((a,b)=>b.score - a.score);
        const top6 = scored.slice(0, Math.min(6, scored.length)).map(x=>x.task.name);

        let html = `<div class="test-result">模拟学生平均能力: ${avg.toFixed(1)} (已创建 3 名学生)。</div>`;
        let matchCount = 0;
        tasks.forEach((task, idx)=>{
          const boosts = task.boosts.map(b => `${b.type}+${b.amount}`).join(', ');
          const isMatch = top6.includes(task.name);
          if(isMatch) matchCount++;
          html += `
            <div class="task-card">
              <div class="task-name">${idx + 1}. ${task.name} ${isMatch?'<strong style="color:#1f8f49;margin-left:8px">[匹配]</strong>':''}</div>
              <div class="task-difficulty">难度: ${task.difficulty}</div>
              <div class="task-boosts">[${boosts}]</div>
            </div>
          `;
        });
        html = `<div class="test-result">抽题结果：匹配数量 ${matchCount} / ${tasks.length}</div>` + html;
        container.innerHTML = html;
      }catch(e){
        container.innerHTML = `<div class="test-result error">✗ 错误: ${e.message}</div>`;
      }
    }

    // 页面加载时自动运行基础测试
    window.onload = function() {
      testTaskPool();
    };
  </script>
</body>
</html>
